from os import listdir
from load import csv_
from copy import deepcopy
from numpy import mean,array,argsort,arange
from random import sample,randrange,random
from igraph import Graph
from scipy.stats import spearmanr



def ROB(a, mode = 'pr'):
	aa=Graph.TupleList(a,directed=False)
	n=float(aa.vcount())
	sc=0
	for rep in range(1,int(n)+1):
		try:
			if mode == 'pr':
				dg=aa.pagerank()
			elif mode == 'bet':
				dg=aa.betweenness()
			else:
				dg = aa.degree()
			DG=dg.index(max(dg))
			aa.delete_vertices(DG)
			sc+=max([len(i) for i in aa.clusters(mode='weak')])/n
		except:
			pass
	return sc/n


	

			
def epn_fast(g,infs,p1=0.1,p2=1,mode='ALL'):
	ggg=g.copy()
	eee=len(g.es)
	ppp=p1+(p1*(1-p2))
	if ppp<1:
		to_del=sample(range(eee),eee-int(round(ppp*eee)))
		ggg.delete_edges(to_del)
	tot=set([])
	for i in infs:
		tot|=set(ggg.subcomponent(i,mode=mode))
	return len(tot)	




from numpy import zeros,trapz,ones
def sir(g,infs,pi,pr):
	g.vs['S']='H'
	for i in infs:
		g.vs[i]['S']='I'
	tot_infs=set(infs[:])
	N=float(len(g.vs))
	n_inf=[]
	while len(infs)>0:
		n_inf.append(len(infs)/N)
		for i in infs:
			nnn=g.neighbors(i,mode='ALL')
			for k in nnn:
				if g.vs[k]['S']=='H' and random()<pi:
					g.vs[k]['S']='I'
					tot_infs|=set([k])
			if random()<pr:
				g.vs[i]['S']='R'
		infs=[i.index for i in g.vs.select(S='I')]
	return len(set(tot_infs))/N
	




fff=listdir('./vole_networks')




y=[]
for ff in fff:
	a=csv_('./vole_networks/'+ff,',')
	g=Graph.TupleList(a,directed=False)
	g.simplify()
	vvv=len(g.vs())
	a=[list(i.tuple) for i in g.es()]  
	rob=ROB(a,mode='bet')
	y.append(rob)
	

y=array(y).argsort().argsort()


out=open('RANK_sir.csv','w')
out.close()		

for p1 in arange(0.1,1.1,0.1):
	for p2 in arange(0.1,1.1,0.1):
		x=[]
		sc=0
		for ff in fff:
			a=csv_('./vole_networks/'+ff,',')
			g=Graph.TupleList(a,directed=False)
			g=g.simplify()
			vvv=len(g.vs())
			inf_n=1#int(round(vvv*0.1))
			if inf_n<1:
				inf_n=1
			ep=mean([epn_fast(g,sample(range(vvv),inf_n),p1,p2) for i in range(100)])
			x.append([ep/float(vvv),random(),sc])
			sc+=1
		x.sort()
		xx=[i[2] for i in x]
		x=[]
		for i in range(sc):
			x.append(xx.index(i))
		x=array(x).argsort().argsort()
		N=float(len(x))
		out=open('RANK_sir.csv','a')
		for i in range(len(x)):
			out.write(','.join(map(str,[x[i]/N,y[i]/N,p1,p2]))+'\n')
		out.close()		
		rho,p=spearmanr(x,y)
		print rho,p1,p2








